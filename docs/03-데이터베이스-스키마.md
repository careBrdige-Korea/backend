# CareBridge Korea - 데이터베이스 스키마

## ERD (Entity Relationship Diagram)

```
┌─────────────┐       1:N        ┌──────────────────┐
│    USERS    │─────────────────▶│  CONSULTATIONS   │
│             │                  │                  │
│ id (PK)     │                  │ id (PK)          │
│ email       │                  │ user_id (FK)     │
│ password    │                  │ user_nickname    │
│ role        │                  │ contact_type     │
│ created_at  │                  │ contact_info     │
└─────────────┘                  │ nationality      │
                                 │ language         │
                                 │ location         │
                                 │ symptoms         │
                                 │ preferred_at     │
                                 │ status           │
                                 │ admin_memo       │
                                 │ created_at       │
                                 └────────┬─────────┘
                                          │
                                          │ 1:N
                                          ▼
┌─────────────┐       1:N        ┌──────────────────┐
│  HOSPITALS  │─────────────────▶│ RECOMMENDATIONS  │
│             │                  │                  │
│ id (PK)     │                  │ id (PK)          │
│ name        │                  │ consultation_id  │
│ region      │                  │ hospital_id (FK) │
│ department  │                  │ is_recommended   │
│ is_foreign_ │                  │ is_selected      │
│   friendly  │                  │ selected_at      │
│ created_at  │                  │ booking_status   │
└─────────────┘                  │ created_at       │
                                 └──────────────────┘
```

---

## 테이블 상세 정의

### 1. `users` - 사용자 및 관리자 계정

로그인 및 권한 관리 테이블

| 컬럼명 | 타입 | 제약 조건 | 설명 |
|--------|------|-----------|------|
| id | INT | PK, Auto Increment | 고유 식별 번호 |
| email | VARCHAR(100) | UNIQUE, NOT NULL | 로그인 아이디 |
| password | VARCHAR(255) | NOT NULL | 암호화된 비밀번호 |
| role | ENUM('USER', 'ADMIN') | NOT NULL, DEFAULT 'USER' | 권한 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 계정 생성 일시 |

```sql
CREATE TABLE users (
    id INT PRIMARY KEY AUTO_INCREMENT,
    email VARCHAR(100) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    role ENUM('USER', 'ADMIN') NOT NULL DEFAULT 'USER',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

---

### 2. `consultations` - 상담 신청 내역

사용자가 입력한 증상과 상담 진행 상태 관리

| 컬럼명 | 타입 | 제약 조건 | 설명 |
|--------|------|-----------|------|
| id | BIGINT | PK, Auto Increment | 상담 고유 번호 |
| user_id | INT | FK (users.id), Nullable | 신청 유저 (비회원 가능) |
| user_nickname | VARCHAR(50) | NOT NULL | 신청자 이름/닉네임 |
| contact_type | ENUM | NOT NULL | 연락 수단 |
| contact_info | VARCHAR(100) | NOT NULL | 연락처 상세 |
| nationality | VARCHAR(50) | - | 국적 |
| language | VARCHAR(50) | - | 사용 언어 |
| location | VARCHAR(100) | - | 희망 지역 / 현재 위치 |
| symptoms | TEXT | - | 증상 및 진료 내용 |
| preferred_at | DATETIME | - | 희망 진료 일시 |
| status | ENUM | DEFAULT 'NEW' | 상담 처리 상태 |
| admin_memo | TEXT | - | 운영자 전용 메모 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 접수 일시 |

**ENUM 값:**
- `contact_type`: 'KAKAOTALK', 'WHATSAPP', 'EMAIL'
- `status`: 'NEW', 'IN_PROGRESS', 'COMPLETED'

```sql
CREATE TABLE consultations (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NULL,
    user_nickname VARCHAR(50) NOT NULL,
    contact_type ENUM('KAKAOTALK', 'WHATSAPP', 'EMAIL') NOT NULL,
    contact_info VARCHAR(100) NOT NULL,
    nationality VARCHAR(50),
    language VARCHAR(50),
    location VARCHAR(100),
    symptoms TEXT,
    preferred_at DATETIME,
    status ENUM('NEW', 'IN_PROGRESS', 'COMPLETED') DEFAULT 'NEW',
    admin_memo TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL
);
```

---

### 3. `hospitals` - 병원 정보 풀

| 컬럼명 | 타입 | 제약 조건 | 설명 |
|--------|------|-----------|------|
| id | INT | PK, Auto Increment | 병원 고유 번호 |
| name | VARCHAR(100) | NOT NULL | 병원명 |
| region | VARCHAR(50) | NOT NULL | 지역 (서울, 경기 등) |
| department | VARCHAR(50) | NOT NULL | 진료과 (내과, 치과 등) |
| is_foreign_friendly | BOOLEAN | DEFAULT TRUE | 외국어 가능 여부 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 등록 일시 |

```sql
CREATE TABLE hospitals (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    region VARCHAR(50) NOT NULL,
    department VARCHAR(50) NOT NULL,
    is_foreign_friendly BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

---

### 4. `recommendations` - 매칭 및 데이터 추적

| 컬럼명 | 타입 | 제약 조건 | 설명 |
|--------|------|-----------|------|
| id | BIGINT | PK, Auto Increment | 추천 기록 고유 번호 |
| consultation_id | BIGINT | FK (consultations.id), NOT NULL | 연결된 상담 ID |
| hospital_id | INT | FK (hospitals.id), NOT NULL | 추천된 병원 ID |
| is_recommended | BOOLEAN | DEFAULT TRUE | 운영자가 추천 리스트에 노출함 |
| is_selected | BOOLEAN | DEFAULT FALSE | 유저가 이 병원을 클릭/선택함 |
| selected_at | TIMESTAMP | NULL | 유저가 선택한 시점 |
| booking_status | ENUM | DEFAULT 'PENDING' | 최종 예약 성공 여부 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 추천 생성 일시 |

**ENUM 값:**
- `booking_status`: 'PENDING', 'SUCCESS', 'FAILED'

**제약 조건:**
- `consultation_id` + `hospital_id` 조합은 UNIQUE (중복 추천 방지)

```sql
CREATE TABLE recommendations (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    consultation_id BIGINT NOT NULL,
    hospital_id INT NOT NULL,
    is_recommended BOOLEAN DEFAULT TRUE,
    is_selected BOOLEAN DEFAULT FALSE,
    selected_at TIMESTAMP NULL,
    booking_status ENUM('PENDING', 'SUCCESS', 'FAILED') DEFAULT 'PENDING',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (consultation_id) REFERENCES consultations(id) ON DELETE CASCADE,
    FOREIGN KEY (hospital_id) REFERENCES hospitals(id) ON DELETE CASCADE,
    UNIQUE KEY unique_consultation_hospital (consultation_id, hospital_id)
);
```

---

## 인덱스

```sql
-- 상담 상태별 조회 최적화
CREATE INDEX idx_consultations_status ON consultations(status);

-- 병원 지역/진료과 조회 최적화
CREATE INDEX idx_hospitals_region ON hospitals(region);
CREATE INDEX idx_hospitals_department ON hospitals(department);

-- 추천 조회 최적화
CREATE INDEX idx_recommendations_consultation ON recommendations(consultation_id);
CREATE INDEX idx_recommendations_hospital ON recommendations(hospital_id);
```
